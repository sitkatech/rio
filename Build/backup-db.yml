# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

jobs:
- job: BackupDB
  displayName: 'Backup Production DB'
  pool:
    vmImage: 'windows-latest'
    demands:
    - sqlpackage
    - azureps

  steps:
  - checkout: none
  - task: SqlAzureDacpacDeployment@1
    name: export
    displayName: 'Export Production DB'
    inputs:
      azureSubscription: 'AzureServiceConnection' #Should be Prod Service Connection
      ServerName: '$(serverName)'
      DatabaseName: '$(databaseName)'
      SqlUsername: '$(sqlAdministrator)'
      SqlPassword: '$(sqlPassword)'
      DeploymentAction: Export

  - publish: '$(export.SqlDeploymentOutputFile)'
    artifact: bacpac

  - task: AzureFileCopy@2
    displayName: 'Copy BacPac to QA Blob storage'
    inputs:
      SourcePath: '$(export.SqlDeploymentOutputFile)'
      azureSubscription: 'AzureServiceConnection' #Should be QA Service Connection
      Destination: 'AzureBlob'
      storage: '$(storageAccountName)'
      ContainerName: 'prod-backup'

